# cs144LAB

## 了解telnet与netcat

建立连接测试http协议

## 邮件

*邮件可用客户端：telnet、netcat、openssl、swaks（测试）*

*qq邮箱的POP3、IMAP、SMTP*

*qq邮箱只支持ssl*

*邮箱地址和授权码都要转成base64码*

```
celestee@Celestee-PC:~$ swaks --to gaokailong65@foxmail.com --from gaokailong65@foxmail.com --server smtp.qq.com
-p 587 -tls -a LOGIN -au 1447716265@qq.com -ap pkejrjnfhvzuhjce
=== Trying smtp.qq.com:587...
=== Connected to smtp.qq.com.
<-  220 newxmesmtplogicsvrszb23-0.qq.com XMail Esmtp QQ Mail Server.
 -> EHLO Celestee-PC.
<-  250-newxmesmtplogicsvrszb23-0.qq.com
<-  250-PIPELINING
<-  250-SIZE 73400320
<-  250-STARTTLS
<-  250-AUTH LOGIN PLAIN XOAUTH XOAUTH2
<-  250-AUTH=LOGIN
<-  250-MAILCOMPRESS
<-  250-SMTPUTF8
<-  250 8BITMIME
 -> STARTTLS
<-  220 Ready to start TLS from 240e:608:702:8000:6045:7395:3538:58a6 to newxmesmtplogicsvrszb23-0.qq.com.
=== TLS started with cipher TLSv1.3:TLS_AES_256_GCM_SHA384:256
=== TLS no local certificate set
=== TLS peer DN="/C=CN/ST=Guangdong Province/L=Shenzhen/O=Shenzhen Tencent Computer Systems Company Limited/CN=*.mail.qq.com"
 ~> EHLO Celestee-PC.
<~  250-newxmesmtplogicsvrszb23-0.qq.com
<~  250-PIPELINING
<~  250-SIZE 73400320
<~  250-AUTH LOGIN PLAIN XOAUTH XOAUTH2
<~  250-AUTH=LOGIN
<~  250-MAILCOMPRESS
<~  250-SMTPUTF8
<~  250 8BITMIME
 ~> AUTH LOGIN
<~  334 VXNlcm5hbWU6
 ~> MTQ0NzcxNjI2NUBxcS5jb20=
<~  334 UGFzc3dvcmQ6
 ~> cGtlanJqbmZodnp1aGpjZQ==
<~  235 Authentication successful
 ~> MAIL FROM:<gaokailong65@foxmail.com>
<~  250 OK
 ~> RCPT TO:<gaokailong65@foxmail.com>
<~  250 OK
 ~> DATA
<~  354 End data with <CR><LF>.<CR><LF>.
 ~> Date: Fri, 08 Aug 2025 21:24:52 +0800
 ~> To: gaokailong65@foxmail.com
 ~> From: gaokailong65@foxmail.com
 ~> Subject: test Fri, 08 Aug 2025 21:24:52 +0800
 ~> Message-Id: <20250808212452.001062@Celestee-PC.>
 ~> X-Mailer: swaks v20201014.0 jetmore.org/john/code/swaks/
 ~>
 ~> This is a test mailing
 ~>
 ~>
 ~> .
<~  250 OK: queued as.
 ~> QUIT
<~* ␦
<~* 221 Bye.
*** Remote host closed connection unexpectedly.

```

### **1. 建立 TCP 连接**

```
=== Trying smtp.qq.com:587...
=== Connected to smtp.qq.com.
<-  220 newxmesmtplogicsvrszb23-0.qq.com XMail Esmtp QQ Mail Server.
```

- **操作**：`swaks` 尝试连接 QQ 邮箱的 SMTP 服务器（端口 587）。
- **响应**：服务器返回 `220`，表示服务就绪，并显示服务器标识。

------

### **2. SMTP 握手（EHLO）**

```
 -> EHLO Celestee-PC.
<-  250-newxmesmtplogicsvrszb23-0.qq.com
<-  250-PIPELINING
<-  250-SIZE 73400320
<-  250-STARTTLS
<-  250-AUTH LOGIN PLAIN XOAUTH XOAUTH2
<-  250-AUTH=LOGIN
<-  250-MAILCOMPRESS
<-  250-SMTPUTF8
<-  250 8BITMIME
```

- **操作**：客户端发送 `EHLO`（扩展握手），声明自己的主机名（`Celestee-PC`）。
- **响应**：服务器返回支持的扩展功能：
  - `STARTTLS`：支持加密升级。
  - `AUTH LOGIN PLAIN`：支持登录认证方式。
  - `SIZE 73400320`：允许的最大邮件大小（约 70MB）。
  - 其他：支持流水线、UTF-8 邮件等。

------

### **3. 升级 TLS 加密（STARTTLS）**

```
 -> STARTTLS
<-  220 Ready to start TLS from 240e:608:702:8000:6045:7395:3538:58a6 to newxmesmtplogicsvrszb23-0.qq.com.
=== TLS started with cipher TLSv1.3:TLS_AES_256_GCM_SHA384:256
=== TLS no local certificate set
=== TLS peer DN="/C=CN/ST=Guangdong Province/L=Shenzhen/O=Shenzhen Tencent Computer Systems Company Limited/CN=*.mail.qq.com"
```

- **操作**：客户端请求升级到 TLS 加密（`STARTTLS`）。
- **响应**：
  - 服务器返回 `220` 同意加密。
  - TLS 握手成功，使用 `TLSv1.3` 和 `AES_256_GCM_SHA384` 加密算法。
  - 服务器证书信息显示为腾讯 QQ 邮箱（验证了身份合法性）。

------

### **4. 加密后的 EHLO**

```
 ~> EHLO Celestee-PC.
<~  250-newxmesmtplogicsvrszb23-0.qq.com
<~  250-PIPELINING
<~  250-SIZE 73400320
<~  250-AUTH LOGIN PLAIN XOAUTH XOAUTH2
<~  250-AUTH=LOGIN
<~  250-MAILCOMPRESS
<~  250-SMTPUTF8
<~  250 8BITMIME
```

- **操作**：在 TLS 加密通道中重新发送 `EHLO`。
- **响应**：服务器再次返回支持的扩展功能（与之前相同）。

------

### **5. 用户认证（AUTH LOGIN）**

```
 ~> AUTH LOGIN
<~  334 VXNlcm5hbWU6
 ~> MTQ0NzcxNjI2NUBxcS5jb20=
<~  334 UGFzc3dvcmQ6
 ~> cGtlanJqbmZodnp1aGpjZQ==
<~  235 Authentication successful
```

- **操作**：
  1. 客户端请求登录（`AUTH LOGIN`）。
  2. 服务器返回 `334 VXNlcm5hbWU6`（`Username:` 的 Base64 编码）。
  3. 客户端发送 Base64 编码的邮箱（`1447716265@qq.com` → `MTQ0NzcxNjI2NUBxcS5jb20=`）。
  4. 服务器返回 `334 UGFzc3dvcmQ6`（`Password:` 的 Base64 编码）。
  5. 客户端发送 Base64 编码的授权码（`pkejrjnfhvzuhjce` → `cGtlanJqbmZodnp1aGpjZQ==`）。
- **响应**：`235 Authentication successful`，表示认证成功。

------

### **6. 设置发件人和收件人**

```
 ~> MAIL FROM:<gaokailong65@foxmail.com>
<~  250 OK
 ~> RCPT TO:<gaokailong65@foxmail.com>
<~  250 OK
```

- **操作**：
  - `MAIL FROM`：声明发件人地址（必须与认证邮箱相同域名，即 `@qq.com` 或 `@foxmail.com`）。
  - `RCPT TO`：声明收件人地址。
- **响应**：`250 OK` 表示地址合法。

------

### **7. 发送邮件内容（DATA）**

```
 ~> DATA
<~  354 End data with <CR><LF>.<CR><LF>.
 ~> Date: Fri, 08 Aug 2025 21:24:52 +0800
 ~> To: gaokailong65@foxmail.com
 ~> From: gaokailong65@foxmail.com
 ~> Subject: test Fri, 08 Aug 2025 21:24:52 +0800
 ~> Message-Id: <20250808212452.001062@Celestee-PC.>
 ~> X-Mailer: swaks v20201014.0 jetmore.org/john/code/swaks/
 ~> 
 ~> This is a test mailing
 ~> 
 ~> 
 ~> .
<~  250 OK: queued as.
```

- **操作**：
  1. 客户端请求发送邮件内容（`DATA`）。
  2. 服务器返回 `354`，表示可以开始传输，以 `\r\n.\r\n` 结束。
  3. 客户端发送邮件头（From/To/Subject 等）和正文。
  4. 以单独一行的 `.` 结束内容。
- **响应**：`250 OK: queued as`，表示邮件已进入发送队列。

------

### **8. 退出连接（QUIT）**

```
 ~> QUIT
<~* ␦
<~* 221 Bye.
*** Remote host closed connection unexpectedly.
```

- **操作**：客户端请求退出（`QUIT`）。
- **响应**：
  - 服务器返回 `221 Bye`，表示连接关闭。
  - `Remote host closed connection unexpectedly` 是正常行为（服务器主动断开）。

------

### **关键点总结**

1. **认证成功**：`235 Authentication successful` 表明授权码正确。
2. **邮件入队**：`250 OK: queued as` 表示邮件已被服务器接收，即将发送。
3. **Foxmail 邮箱兼容性**：虽然认证使用 `@qq.com`，但发件人地址可以是同域的 `@foxmail.com`（两者属于 QQ 邮箱体系）。
4. **连接关闭**：`221 Bye` 是 SMTP 协议的标准退出方式。

## server

使用netcat建立TCP服务器，使用telnet连接

可靠连接：网络Internet不提供可靠连接，协议TCP来干这件事

## minnow

用课程给出的socket的C++封装写一段程序，完成前面的连接cs144.keithw.org获取hello页面。但在执行程序时，cs144.keithw.org返回了forbidden，没有权限。

![image-20250810151145663](E:\learning_record\计算机网络\cs144.assets\image-20250810151145663.png)

telnet手动输入则没问题。发现是http格式问题，修改后成功拿到页面。

![image-20250810152440635](E:\learning_record\计算机网络\cs144.assets\image-20250810152440635.png)

但在查问题的过程中，发现wsl网络总出问题，准备先学一下wsl网络和网络代理相关内容。
